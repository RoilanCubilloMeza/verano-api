<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSCarBikes - Comparador de Veh√≠culos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .search-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
        }

        .search-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
            padding: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #f5f5f5;
        }

        .autocomplete-item img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
        }

        .autocomplete-item .info {
            flex: 1;
        }

        .autocomplete-item .name {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .autocomplete-item .details {
            font-size: 13px;
            color: #666;
        }

        .selected-vehicle {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .selected-vehicle h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .selected-vehicle .vehicle-card {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .selected-vehicle img {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
        }

        .compare-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .compare-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .compare-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .comparison-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .comparison-section.active {
            display: block;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .vehicle-details {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .vehicle-details h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .vehicle-details img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: bold;
            color: #555;
        }

        .detail-value {
            color: #333;
        }

        .differences {
            grid-column: 1 / -1;
            margin-top: 20px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
        }

        .differences h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .difference-item {
            padding: 10px 0;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Comparador de Veh√≠culos VSCarBikes</h1>

        <div class="search-section">
            <div class="search-container">
                <div class="search-box">
                    <h3>Veh√≠culo 1</h3>
                    <input 
                        type="text" 
                        id="search1" 
                        placeholder="Buscar por marca, modelo o versi√≥n..."
                        autocomplete="off"
                    >
                    <div id="results1" class="autocomplete-results" style="display: none;"></div>
                    <div id="selected1" class="selected-vehicle" style="display: none;"></div>
                </div>

                <div class="search-box">
                    <h3>Veh√≠culo 2</h3>
                    <input 
                        type="text" 
                        id="search2" 
                        placeholder="Buscar por marca, modelo o versi√≥n..."
                        autocomplete="off"
                    >
                    <div id="results2" class="autocomplete-results" style="display: none;"></div>
                    <div id="selected2" class="selected-vehicle" style="display: none;"></div>
                </div>
            </div>

            <button id="compareBtn" class="compare-button" disabled>
                Comparar Veh√≠culos
            </button>
        </div>

        <div id="comparisonSection" class="comparison-section">
            <h2 style="color: #667eea; text-align: center; margin-bottom: 20px;">
                üìä Comparaci√≥n Detallada
            </h2>
            <div id="comparisonContent"></div>
        </div>
    </div>

    <script>
        let selectedVehicles = {
            vehicle1: null,
            vehicle2: null
        };

        let searchTimeout = null;

        // Configurar b√∫squeda para ambos inputs
        setupSearch('search1', 'results1', 'selected1', 'vehicle1');
        setupSearch('search2', 'results2', 'selected2', 'vehicle2');

        function setupSearch(inputId, resultsId, selectedId, vehicleKey) {
            const input = document.getElementById(inputId);
            const resultsDiv = document.getElementById(resultsId);
            const selectedDiv = document.getElementById(selectedId);

            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                clearTimeout(searchTimeout);

                if (query.length < 2) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/vehicles/search?q=${encodeURIComponent(query)}&limit=8`);
                        const data = await response.json();

                        if (data.success && data.data.length > 0) {
                            displayResults(data.data, resultsDiv, selectedDiv, vehicleKey, input);
                        } else {
                            resultsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">No se encontraron resultados</div>';
                            resultsDiv.style.display = 'block';
                        }
                    } catch (error) {
                        console.error('Error en b√∫squeda:', error);
                        resultsDiv.innerHTML = '<div style="padding: 15px; text-align: center; color: #dc3545;">Error al buscar</div>';
                        resultsDiv.style.display = 'block';
                    }
                }, 300);
            });

            // Cerrar resultados al hacer click fuera
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        function displayResults(results, resultsDiv, selectedDiv, vehicleKey, input) {
            resultsDiv.innerHTML = results.map(vehicle => `
                <div class="autocomplete-item" data-vehicle='${JSON.stringify(vehicle)}'>
                    <img src="${vehicle.image || 'https://via.placeholder.com/80x60?text=Sin+Imagen'}" alt="${vehicle.label}">
                    <div class="info">
                        <div class="name">${vehicle.label}</div>
                        <div class="details">
                            ${vehicle.category} ‚Ä¢ $${vehicle.price.toLocaleString()}
                        </div>
                    </div>
                </div>
            `).join('');

            resultsDiv.style.display = 'block';

            // Agregar eventos de click a cada resultado
            resultsDiv.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const vehicle = JSON.parse(item.dataset.vehicle);
                    selectVehicle(vehicle, selectedDiv, vehicleKey, input);
                    resultsDiv.style.display = 'none';
                });
            });
        }

        function selectVehicle(vehicle, selectedDiv, vehicleKey, input) {
            selectedVehicles[vehicleKey] = vehicle;
            
            input.value = vehicle.label;

            selectedDiv.innerHTML = `
                <h4>‚úì Veh√≠culo Seleccionado</h4>
                <div class="vehicle-card">
                    <img src="${vehicle.image || 'https://via.placeholder.com/120x90?text=Sin+Imagen'}" alt="${vehicle.label}">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${vehicle.label}</div>
                        <div style="color: #666; font-size: 14px;">
                            ${vehicle.category} ‚Ä¢ $${vehicle.price.toLocaleString()}
                        </div>
                    </div>
                </div>
            `;
            selectedDiv.style.display = 'block';

            updateCompareButton();
        }

        function updateCompareButton() {
            const compareBtn = document.getElementById('compareBtn');
            const canCompare = selectedVehicles.vehicle1 && selectedVehicles.vehicle2;
            
            compareBtn.disabled = !canCompare;
            
            if (canCompare) {
                compareBtn.textContent = `Comparar ${selectedVehicles.vehicle1.brand} vs ${selectedVehicles.vehicle2.brand}`;
            } else {
                compareBtn.textContent = 'Selecciona ambos veh√≠culos para comparar';
            }
        }

        document.getElementById('compareBtn').addEventListener('click', async () => {
            const comparisonSection = document.getElementById('comparisonSection');
            const comparisonContent = document.getElementById('comparisonContent');

            comparisonContent.innerHTML = '<div class="loading">‚è≥ Cargando comparaci√≥n...</div>';
            comparisonSection.classList.add('active');
            comparisonSection.scrollIntoView({ behavior: 'smooth' });

            try {
                const id1 = selectedVehicles.vehicle1.id;
                const id2 = selectedVehicles.vehicle2.id;
                
                const response = await fetch(`/api/vehicles/compare?ids=${id1},${id2}`);
                const data = await response.json();

                if (data.success) {
                    displayComparison(data.data);
                } else {
                    throw new Error(data.error || 'Error al comparar');
                }
            } catch (error) {
                comparisonContent.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        });

        function displayComparison(comparison) {
            const comparisonContent = document.getElementById('comparisonContent');
            const { vehicle1, vehicle2, differences } = comparison;

            comparisonContent.innerHTML = `
                <div class="comparison-grid">
                    <div class="vehicle-details">
                        <h3>${vehicle1.brand} ${vehicle1.model} ${vehicle1.version}</h3>
                        <img src="${vehicle1.image || 'https://via.placeholder.com/600x250?text=Sin+Imagen'}" alt="${vehicle1.brand}">
                        
                        <div class="detail-row">
                            <span class="detail-label">A√±o:</span>
                            <span class="detail-value">${vehicle1.year}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Precio:</span>
                            <span class="detail-value">$${vehicle1.price.toLocaleString()}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Categor√≠a:</span>
                            <span class="detail-value">${vehicle1.category}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Calificaci√≥n:</span>
                            <span class="detail-value">‚≠ê ${vehicle1.averageRating.toFixed(1)} (${vehicle1.totalOpinions} opiniones)</span>
                        </div>
                        ${vehicle1.pdf ? `<div class="detail-row"><span class="detail-label">Ficha T√©cnica:</span><span class="detail-value"><a href="${vehicle1.pdf}" target="_blank">üìÑ Ver PDF</a></span></div>` : ''}
                    </div>

                    <div class="vehicle-details">
                        <h3>${vehicle2.brand} ${vehicle2.model} ${vehicle2.version}</h3>
                        <img src="${vehicle2.image || 'https://via.placeholder.com/600x250?text=Sin+Imagen'}" alt="${vehicle2.brand}">
                        
                        <div class="detail-row">
                            <span class="detail-label">A√±o:</span>
                            <span class="detail-value">${vehicle2.year}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Precio:</span>
                            <span class="detail-value">$${vehicle2.price.toLocaleString()}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Categor√≠a:</span>
                            <span class="detail-value">${vehicle2.category}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Calificaci√≥n:</span>
                            <span class="detail-value">‚≠ê ${vehicle2.averageRating.toFixed(1)} (${vehicle2.totalOpinions} opiniones)</span>
                        </div>
                        ${vehicle2.pdf ? `<div class="detail-row"><span class="detail-label">Ficha T√©cnica:</span><span class="detail-value"><a href="${vehicle2.pdf}" target="_blank">üìÑ Ver PDF</a></span></div>` : ''}
                    </div>

                    <div class="differences">
                        <h3>üìà Diferencias Clave</h3>
                        <div class="difference-item">
                            üí∞ <strong>Precio:</strong> Diferencia de $${differences.priceDifference.toLocaleString()} 
                            (${differences.cheaperVehicle === 'vehicle1' ? vehicle1.brand + ' ' + vehicle1.model : vehicle2.brand + ' ' + vehicle2.model} es m√°s econ√≥mico)
                        </div>
                        <div class="difference-item">
                            üìÖ <strong>A√±o:</strong> ${differences.yearDifference} a√±o(s) de diferencia 
                            (${differences.newerVehicle === 'vehicle1' ? vehicle1.brand + ' ' + vehicle1.model : vehicle2.brand + ' ' + vehicle2.model} es m√°s nuevo)
                        </div>
                        <div class="difference-item">
                            ‚≠ê <strong>Calificaci√≥n:</strong> ${differences.ratingDifference.toFixed(1)} puntos de diferencia 
                            (${differences.betterRated === 'vehicle1' ? vehicle1.brand + ' ' + vehicle1.model : vehicle2.brand + ' ' + vehicle2.model} tiene mejor rating)
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
