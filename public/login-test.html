<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }
        
        .hidden {
            display: none !important;
        }
        
        .console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-line {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Login Test</h1>
        
        <!-- PASO 1: EMAIL Y PASSWORD -->
        <div id="step1">
            <h2>Paso 1: Credenciales</h2>
            <div class="input-group">
                <label>Email:</label>
                <input type="email" id="email" placeholder="ejemplo@gmail.com">
            </div>
            <div class="input-group">
                <label>Contrase√±a:</label>
                <input type="password" id="password" placeholder="contrase√±a">
            </div>
            <button onclick="sendLogin()">Enviar</button>
        </div>
        
        <!-- PASO 2: OTP -->
        <div id="step2" class="hidden">
            <h2>Paso 2: C√≥digo OTP</h2>
            <p>Revisa tu correo: <strong id="emailShown"></strong></p>
            <div class="input-group">
                <label>C√≥digo OTP (6 d√≠gitos):</label>
                <input type="text" id="otp" placeholder="123456" maxlength="6">
            </div>
            <button onclick="verifyOTP()">Verificar</button>
            <button onclick="goBack()" style="background: #999; margin-top: 5px;">Volver</button>
            <button onclick="debugOTP()" style="background: #f39c12; margin-top: 5px;">Ver OTP en BD (Debug)</button>
        </div>
        
        <div id="message" class="message"></div>
        <div id="console" class="console"></div>
    </div>

    <script>
        let currentEmail = '';
        let isVerifying = false;  // Flag para evitar m√∫ltiples env√≠os

        function log(msg) {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = 'log-line';
            line.textContent = msg;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function showMessage(msg, type) {
            const msgEl = document.getElementById('message');
            msgEl.className = 'message ' + type;
            msgEl.textContent = msg;
        }

        async function sendLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showMessage('‚ùå Por favor completa email y password', 'error');
                return;
            }

            log(`üì§ Enviando: email=${email}, password length=${password.length}`);

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                log(`üì• Status: ${response.status}`);
                const data = await response.json();
                
                // Mostrar logs del servidor si existen
                if (data.data?.logs && Array.isArray(data.data.logs)) {
                    log('üìä === LOGS DEL SERVIDOR ===');
                    data.data.logs.forEach(logMsg => log(`   ${logMsg}`));
                    log('üìä === FIN LOGS ===');
                }

                if (response.ok) {
                    const resData = data.data || data;
                    if (resData.requiresOTP) {
                        log('‚úÖ OTP requerido - Cambiando a Paso 2');
                        currentEmail = email;
                        document.getElementById('emailShown').textContent = email;
                        document.getElementById('step1').classList.add('hidden');
                        document.getElementById('step2').classList.remove('hidden');
                        document.getElementById('otp').focus();
                        showMessage('‚úÖ C√≥digo OTP enviado a tu correo', 'success');
                    } else {
                        showMessage('‚ö†Ô∏è Respuesta inesperada', 'error');
                    }
                } else {
                    showMessage(`‚ùå ${data.error || 'Error en el servidor'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                showMessage(`‚ùå ${error.message}`, 'error');
            }
        }

        async function verifyOTP() {
            // Evitar m√∫ltiples env√≠os
            if (isVerifying) {
                log('‚ö†Ô∏è Verificaci√≥n ya en proceso...');
                return;
            }

            const otp = document.getElementById('otp').value;

            if (!otp || otp.length !== 6) {
                showMessage('‚ùå Ingresa un c√≥digo de 6 d√≠gitos', 'error');
                return;
            }

            isVerifying = true;  // Marcar como verificando
            log(`üì§ Verificando: email=${currentEmail}, otp=${otp}`);

            try {
                const payload = { email: currentEmail, otp };
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                log(`üì• Status: ${response.status}`);
                const data = await response.json();
                
                // Mostrar logs del servidor si existen
                if (data.data?.logs && Array.isArray(data.data.logs)) {
                    log('üìä === LOGS DEL SERVIDOR ===');
                    data.data.logs.forEach(logMsg => log(`   ${logMsg}`));
                    log('üìä === FIN LOGS ===');
                }

                if (response.ok) {
                    const resData = data.data || data;
                    if (resData.token) {
                        log('‚úÖ‚úÖ‚úÖ LOGIN EXITOSO');
                        log(`üîë Token: ${resData.token.substring(0, 50)}...`);
                        log(`üë§ Usuario: ${resData.user.name} (${resData.user.email})`);
                        
                        localStorage.setItem('authToken', resData.token);
                        localStorage.setItem('user', JSON.stringify(resData.user));
                        
                        showMessage(`‚úÖ Login exitoso!\n\nToken: ${resData.token.substring(0, 30)}...\n\nVerifica la consola para ver m√°s detalles.`, 'success');
                    }
                } else {
                    log(`‚ùå Error ${response.status}: ${data.error}`);
                    showMessage(`‚ùå ${data.error || 'OTP inv√°lido'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                showMessage(`‚ùå ${error.message}`, 'error');
            } finally {
                isVerifying = false;  // Permitir nuevo intento
            }
        }

        function goBack() {
            log('üîô Volviendo al paso 1');
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('message').style.display = 'none';
            document.getElementById('otp').value = '';
        }

        async function debugOTP() {
            log('üîç Consultando OTP en la BD...');
            try {
                const response = await fetch(`/api/auth/debug?email=${encodeURIComponent(currentEmail)}`);
                log(`üì• Status: ${response.status}`);
                const data = await response.json();
                log(`üìÑ Response: ${JSON.stringify(data)}`);

                if (response.ok && data.data?.otp) {
                    const otp = data.data.otp;
                    log(`‚úÖ OTP encontrado en BD: ${otp.otp}`);
                    log(`‚è∞ Expira en: ${otp.expiresInSeconds} segundos`);
                    log(`üìÖ Expiraci√≥n: ${otp.expiryTime}`);
                    
                    if (otp.expired) {
                        log('‚ö†Ô∏è El OTP ha expirado');
                        showMessage('‚ùå El OTP ha expirado, solicita uno nuevo', 'error');
                    } else {
                        log(`üí° Copia este c√≥digo al campo: ${otp.otp}`);
                        document.getElementById('otp').value = otp.otp;
                        document.getElementById('otp').focus();
                    }
                } else if (response.ok) {
                    log('‚ö†Ô∏è No hay OTP guardado para este usuario');
                    showMessage('‚ùå No hay OTP guardado. Revisa que hayas enviado las credenciales correctamente.', 'error');
                } else {
                    log(`‚ùå Error: ${data.error}`);
                    showMessage(`‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                showMessage(`‚ùå ${error.message}`, 'error');
            }
        }

        log('üöÄ Sistema de login iniciado');
        log('Ingresa email y contrase√±a, luego verifica el OTP');
    </script>
</body>
</html>